<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

<link rel="icon" href="/storage/brand/hairlight-icon.svg" type="image/svg+xml"/>
<link rel="apple-touch-icon" href="/storage/brand/hairlight-icon.svg">
<link rel="manifest" href="/storage/brand/manifest.webmanifest">

<!-- ç¤¾ç¾¤åˆ†äº« Open Graph -->
<meta property="og:title" content="æ˜ é«®ï½œä¸€é¡æ›é«®ï¼ˆHairLight Studioï¼‰">
<meta property="og:description" content="æœªå‰ªå…ˆè¦‹ï¼Œä¸€é¡æ›é«®ï¼šä¸Šå‚³é¡§å®¢ç…§ï¼‹åƒè€ƒé«®å‹ï¼Œå³åˆ»é è¦½è‡ªç„¶é«®éš›èˆ‡å…‰å½±èåˆçš„æœ€çµ‚æ•ˆæœã€‚">
<meta property="og:image" content="/storage/brand/hairlight-wordmark.svg">
<meta property="og:type" content="website">
<meta name="theme-color" content="#5B5AE7">
<style>
  :root{
    /* Brand palette */
    --ring:#5B5AE7;           /* ä¸»è‰²ï¼šå†·ç´«é› */
    --ring-weak:#A8B2FF;      /* ä¸»è‰²å¼±åŒ–/hover */
    --glow-mint:#49E6D6;      /* è£œå…‰è–„è·é’ */
    --hair-brown:#8A6B52;     /* é«®æ£•ï¼ˆä¸­æ€§è‰²ï¼‰ */

    /* UI tokens */
    --bg:#f7f7f8; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb;
    --text:#111827; --text-weak:#374151;
    --radius:14px; --shadow:0 8px 28px rgba(17,24,39,.08); --container:1120px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
  a,button{transition:.2s ease}
  .container{max-width:var(--container);margin:0 auto;padding:18px 16px 88px}

  /* AppBar */
  .appbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#ffffffee,#ffffffd0 75%,#ffffff00);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--line)}
  .appbar .inner{max-width:var(--container);margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 210deg, var(--ring), #22d3ee 18%, #c084fc 44%, var(--ring) 82%);box-shadow:0 4px 16px rgba(79,70,229,.25)}
  .title{font-weight:800;letter-spacing:.3px}

  /* Uploader */
  fieldset{border:1px solid var(--line);border-radius:var(--radius);background:var(--card);padding:14px;margin:14px 0;box-shadow:var(--shadow)}
  legend{padding:0 8px;color:var(--text-weak)}
  .uploader-grid{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .uploader{width:150px;aspect-ratio:1/1;border:2px dashed var(--line);border-radius:12px;background:#fff;position:relative;display:flex;align-items:center;justify-content:center;color:#6b7280;box-shadow:0 2px 10px rgba(17,24,39,.05);overflow:hidden}
  /* input æ°¸é ç½®é ‚å¯é»ï¼šå–®æ¬¡é»æ“Šå³å½ˆå‡ºé¸æª” */
  .uploader input{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:10;pointer-events:auto}
  .uploader img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:10px;z-index:0}
  .uploader .hint{position:absolute;bottom:8px;left:8px;background:#111c;color:#fff;border:1px solid #ffffff20;padding:4px 8px;border-radius:999px;font-size:12px;z-index:1}
  .uploader:focus-within{outline:3px solid var(--ring-weak)}
  .uploader .redo{position:absolute;top:8px;right:8px;background:#ffffffe6;border:1px solid var(--line);border-radius:999px;font-size:12px;padding:4px 8px;cursor:pointer;display:none;z-index:20}
  .uploader.has-img .redo{display:inline-block}
  .actions-inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;box-shadow:0 1px 6px rgba(17,24,39,.06)}
  .btn.primary{background:var(--ring);border-color:var(--ring);color:#fff;box-shadow:0 6px 18px rgba(91,90,231,.25)}
  .btn:active{transform:translateY(1px)}
  .help{color:#6b7280;font-size:13px}

  /* Candidates */
  .section-title{font-size:18px;margin:18px 4px 8px;color:var(--text)} .subtle{color:#6b7280;font-size:13px;margin:6px 4px 0}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;box-shadow:var(--shadow);position:relative;overflow:hidden;transition:transform .12s ease, box-shadow .12s ease}
  .card:hover{transform:translateY(-1px); box-shadow:0 10px 28px rgba(17,24,39,.12)}
  .card img{width:100%;border-radius:8px;display:block}
  .ribbon{position:absolute;top:10px;left:-40px;transform:rotate(-12deg);background:var(--ring);color:#fff;padding:6px 50px;font-size:12px;box-shadow:0 6px 16px rgba(91,90,231,.25)}
  .tag{position:absolute;top:10px;left:10px;background:#111;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px}
  .chip{position:absolute;top:10px;right:10px;background:#111;color:#fff;border-radius:999px;padding:4px 8px;font-size:12px;opacity:.92}
  .scores{display:flex;gap:6px;margin-top:6px}
  .scores .mini{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:2px 6px;font-size:12px;color:#374151}
  .card.pick{outline:3px solid var(--ring);outline-offset:2px}

  /* Compare */
  .compare{margin-top:18px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .toolrow{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .link{color:var(--ring);text-decoration:none;border-bottom:1px dashed var(--ring-weak);padding-bottom:1px}
  .compare img{max-width:100%;border-radius:10px;display:block;border:1px solid var(--line);box-shadow:0 6px 18px rgba(17,24,39,.06)}

  /* FAB */
  .fab{position:fixed;left:0;right:0;bottom:0;z-index:60;background:#fffffff2;backdrop-filter:saturate(120%) blur(8px);border-top:1px solid var(--line);padding:10px 12px;padding-bottom:calc(10px + env(safe-area-inset-bottom));display:flex;gap:10px;justify-content:center}
  .fab .btn{min-width:240px}

  /* Busy & Toast */
  #busy{position:fixed;inset:0;background:rgba(255,255,255,.75);display:none;align-items:center;justify-content:center;z-index:70}
  #busy .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px 18px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center}
  .spinner{width:20px;height:20px;border:3px solid var(--line);border-top-color:var(--ring);border-radius:50%;animation:spin 1s linear infinite} @keyframes spin{to{transform:rotate(360deg)}}
  .toast{position:fixed;inset:auto 0 22px 0;display:flex;justify-content:center;pointer-events:none;z-index:100}
  .toast .msg{pointer-events:auto;max-width:90vw;background:#111;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 8px 24px rgba(0,0,0,.25)}

  /* Viewer */
  .viewer{position:fixed;inset:0;background:#000a;display:none;flex-direction:column;z-index:80}
  .vbar{display:flex;gap:8px;align-items:center;background:#fff;padding:8px 12px;border-bottom:1px solid var(--line)} .vbar .grow{flex:1}
  .vstage{position:relative;flex:1;touch-action:none;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000}
  #vImg{max-width:none;transform-origin:center center;user-select:none;-webkit-user-drag:none}

  /* Menu (single instance) */
  .menu{position:fixed;display:none;z-index:90;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);min-width:160px;overflow:hidden;animation:menuIn .12s ease}
  .menu button{display:block;width:100%;padding:10px 12px;border:0;background:#fff;text-align:left;font-size:14px}
  .menu button:hover{background:#f3f4f6}
  @keyframes menuIn{from{transform:translateY(4px);opacity:.0}to{transform:none;opacity:1}}

  @media (max-width:860px){ .grid{grid-template-columns:1fr 1fr} .fab .btn{min-width:unset;width:100%} }
/* ===== Brand Typography (HairLight) ===== */
.brand-wrap{display:flex;gap:12px;align-items:center}
.brand-icon{border-radius:8px;flex:0 0 auto}
.brand-text{display:flex;flex-direction:column;line-height:1.05}
.brand-title{font-weight:800;font-size:22px;letter-spacing:.3px;color:var(--text)}
.brand-sub{font-weight:600;font-size:13px;color:var(--ring);margin-top:2px}
/* ä¿è­‰ä¸æœƒè¢«é€£çµè—è‰²æ±¡æŸ“ï¼ˆè‹¥å¤–å±¤æ›¾ç”¨ <a>ï¼‰ï¼š */
.appbar .inner a, .appbar .inner a:link, .appbar .inner a:visited{color:inherit;text-decoration:none}
/* æŠ—é‹¸é½’èˆ‡æ˜“è®€æ€§ */
html,body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
</style>

<body>
  <div class="appbar"><div class="inner">
  <div class="brand-wrap">
    <img src="/storage/brand/hairlight-icon.svg" alt="æ˜ é«® HairLight" width="28" height="28" class="brand-icon"/>
    <div class="brand-text">
      <div class="brand-title">æ˜ é«®ï½œä¸€é¡æ›é«®</div>
      <div class="brand-sub">HairLight Studio</div>
    </div>
  </div>
  <div style="flex:1"></div>
</div></div></div></div>

  <div id="busy"><div class="box"><div class="spinner"></div><div id="busyText">è™•ç†ä¸­â€¦</div></div></div>
  <div class="toast" id="toast" style="display:none"><div class="msg" id="toastMsg"></div></div>

  <div class="container">
    <fieldset>
      <legend>ä¸€éµæ–°ä»»å‹™ï¼ˆæ‹ç…§ / é¸åœ–ï¼‰</legend>
      <div class="uploader-grid">
        <!-- é¡§å®¢ç…§ -->
        <label class="uploader" title="æ‹ç…§æˆ–é¸åœ–">
          <input id="userFile" type="file" accept="image/*">
          <img id="userThumb" alt="">
          <span class="hint">é¡§å®¢ç…§</span>
        </label>
        <div class="actions-inline" style="gap:6px;margin-top:6px">
          <button id="btnUserCamera" class="btn">ğŸ“· æ‹ç…§</button>
          <button id="btnUserGallery" class="btn">ğŸ–¼ å¾ç›¸ç°¿</button>
        </div>

        <!-- åƒè€ƒé«®å‹ -->
        <label class="uploader" title="æ‹ç…§æˆ–é¸åœ–">
          <input id="styleFile" type="file" accept="image/*">
          <img id="styleThumb" alt="">
          <span class="hint">åƒè€ƒé«®å‹</span>
        </label>
        <div class="actions-inline" style="gap:6px;margin-top:6px">
          <button id="btnStyleCamera" class="btn">ğŸ“· æ‹ç…§</button>
          <button id="btnStyleGallery" class="btn">ğŸ–¼ å¾ç›¸ç°¿</button>
        </div>

        <div class="actions-inline">
          <button class="btn primary" id="newRun">å»ºç«‹ä¸¦è‡ªå‹•ç”Ÿæˆ</button>
          <button id="wipe" class="btn" style="margin-left:8px;">æ¸…é™¤æ­¤é è³‡æ–™</button>
        </div>
      </div>
    </fieldset>

    <div class="section-title" id="title">å€™é¸çµæœï¼ˆé•·æŒ‰æˆ–å³éµ â†’ æ”¾å¤§ï¼ä¸‹è¼‰ï¼åˆ†äº«ï¼‰</div>
    <div id="styleDesc" class="hint" style="margin:6px 4px 12px; color:#555;"></div>
    <div class="grid" id="grid"></div>
    <div class="subtle" id="hint"></div>

    <div id="compareWrap" class="compare" style="display:none">
      <div class="toolrow"><a id="compareLink" class="link" target="_blank">åœ¨æ–°åˆ†é é–‹å•Ÿ</a><button id="copyLink" class="btn">è¤‡è£½é€£çµ</button></div>
      <img id="compareImg" alt="compare preview"/>
    </div>
  </div>

  <div class="fab"><button id="use" class="btn primary">ä½¿ç”¨é€™å¼µç”¢å‡ºå°æ¯”åœ–</button></div>

  <div id="viewer" class="viewer">
    <div class="vbar"><button id="vClose" class="btn">é—œé–‰</button><a id="vOpen" class="btn" target="_blank">æ–°åˆ†é </a><button id="vDownload" class="btn">ä¸‹è¼‰</button><div class="grow"></div><button id="vMinus" class="btn">ï¼</button><button id="vPlus" class="btn">ï¼‹</button><button id="vReset" class="btn">é‡ç½®</button></div>
    <div class="vstage"><img id="vImg" alt="preview"></div>
  </div>

  <div id="menu" class="menu"><button data-act="zoom">æ”¾å¤§</button><button data-act="download">ä¸‹è¼‰</button><button data-act="share">åˆ†äº«</button></div>

<script>
const $ = s => document.querySelector(s);
const toast = t => { $("#toastMsg").textContent=t; $("#toast").style.display="flex"; setTimeout(()=>$("#toast").style.display="none", 2200); };
const busy  = (on,msg="è™•ç†ä¸­â€¦") => { $("#busyText").textContent=msg; $("#busy").style.display=on?"flex":"none"; };
async function fetchJSON(u,o){ const r=await fetch(u,o); let d; try{ d=await r.json(); }catch{ d={error:await r.text()}; } if(!r.ok) throw new Error(d?.error||('HTTP '+r.status)); return d; }
async function fetchJob(id){ return fetchJSON(`/api/job/${id}`); }
async function fetchLastJob(){ return fetchJSON("/api/last-job"); }

/* å¯é ç¸®åœ–ï¼šobjectURL â†’ FileReader fallback */
function setThumb(file, img, box){
  if(!file) return;
  try{ const obj=URL.createObjectURL(file); img.onload=()=>URL.revokeObjectURL(obj); img.src=obj; }
  catch{ const rd=new FileReader(); rd.onload=e=>img.src=e.target.result; rd.readAsDataURL(file); }
  box.classList.add("has-img");
}

/* ===== Viewerï¼ˆæ‹–æ›³ + é›™æŒ‡/é›™æ“Šï¼‰ ===== */
let vScale=1,vX=0,vY=0,vSrc="";
const applyT=()=> $("#vImg").style.transform=`translate(${vX}px,${vY}px) scale(${vScale})`;
const openViewer=(src)=>{ vSrc=src; $("#viewer").style.display="flex"; $("#vImg").src=src; $("#vOpen").href=src; vScale=1; vX=0; vY=0; applyT(); };
$("#vClose").onclick=()=> $("#viewer").style.display="none";
$("#vPlus").onclick =()=>{ vScale=Math.min(6,vScale*1.2); applyT(); };
$("#vMinus").onclick=()=>{ vScale=Math.max(0.5,vScale/1.2); applyT(); };
$("#vReset").onclick=()=>{ vScale=1; vX=0; vY=0; applyT(); };
async function downloadSmart(url, filename){ try{ const r=await fetch(url,{cache:"no-store"}); const b=await r.blob(); const o=URL.createObjectURL(b); const a=document.createElement("a"); a.href=o; a.download=filename||url.split("/").pop(); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(o),2000);}catch{ window.open(url,"_blank"); } }
(function(){ let pts=new Map(), lastDist=0,lastCx=0,lastCy=0; const st=$(".vstage");
  const set=e=>pts.set(e.pointerId,{x:e.clientX,y:e.clientY}); const del=e=>{pts.delete(e.pointerId);lastDist=0;};
  st.addEventListener("pointerdown",e=>{st.setPointerCapture(e.pointerId);set(e)}); st.addEventListener("pointerup",del); st.addEventListener("pointercancel",del);
  st.addEventListener("pointermove",e=>{
    if(!pts.has(e.pointerId)) return; set(e);
    if(pts.size===2){ const [p1,p2]=[...pts.values()], dx=p2.x-p1.x, dy=p2.y-p1.y; const dist=Math.hypot(dx,dy);
      const cx=(p1.x+p2.x)/2, cy=(p1.y+p2.y)/2;
      if(lastDist){ const ratio=dist/lastDist, nx=Math.min(6,Math.max(0.5,vScale*ratio));
        vX = cx - (cx - vX)*(nx/vScale); vY = cy - (cy - vY)*(nx/vScale); vScale=nx; applyT();
        vX += (cx-lastCx); vY += (cy-lastCy); applyT(); }
      lastDist=dist; lastCx=cx; lastCy=cy;
    } else if(pts.size===1){ vX+=e.movementX; vY+=e.movementY; applyT(); }
  });
  let lastTap=0; st.addEventListener("pointerup",e=>{ const now=Date.now();
    if(now-lastTap<280){ const r=st.getBoundingClientRect(), cx=e.clientX-r.left, cy=e.clientY-r.top; const target=vScale<1.8?2:1;
      vX = cx - (cx - vX)*(target/vScale); vY = cy - (cy - vY)*(target/vScale); vScale=target; applyT(); lastTap=0; } else lastTap=now; });
})();

/* ===== å–®ä¾‹é•·æŒ‰/å³éµé¸å–® ===== */
(function(){
  const menu = document.getElementById("menu");
  let menuSrc = "";
  function showMenu(x,y,src){ const vw=innerWidth,vh=innerHeight,mw=170,mh=120; menuSrc=src; menu.style.left=Math.min(vw-mw-8,Math.max(8,x))+"px"; menu.style.top=Math.min(vh-mh-8,Math.max(8,y))+"px"; menu.style.display="block"; }
  const hideMenu=()=> menu.style.display="none";
  menu.addEventListener("click", async e=>{
    const act=e.target.dataset.act;
    if(act==="zoom") openViewer(menuSrc);
    if(act==="download") await downloadSmart(menuSrc);
    if(act==="share" && navigator.share){ try{ await navigator.share({ title:"æ˜ é«®ï½œä¸€é¡æ›é«®ï¼ˆHairLight Studioï¼‰", url:menuSrc }); }catch{} }
    hideMenu();
  });
  document.addEventListener("click",e=>{ if(!menu.contains(e.target)) hideMenu(); });
  document.addEventListener("scroll", hideMenu, true);
  document.addEventListener("contextmenu", e=>{ if(e.target.matches("img.ctx")) e.preventDefault(); });
  window.attachCtx = function(img){
    img.classList.add("ctx");
    img.addEventListener("contextmenu",e=>{e.preventDefault();showMenu(e.clientX,e.clientY,img.src);});
    let t=null; img.addEventListener("touchstart",ev=>{ if(t)clearTimeout(t); const p=ev.touches[0]; t=setTimeout(()=>showMenu(p.clientX,p.clientY,img.src),450); },{passive:true});
    ["touchend","touchmove","touchcancel"].forEach(ev=> img.addEventListener(ev,()=>t&&clearTimeout(t),{passive:true}));
  };
})();

/* ===== App state / render / loadJob ===== */
let state={ job:null, pick:null, meta:null, userPath:null, stylePath:null };

function render(job){
  state.meta=job.meta||{}; const auto=(state.meta.autopick_index||1)-1; const list=job.results||[];
  const grid=document.getElementById("grid"); grid.innerHTML="";
  document.getElementById("title").textContent=(job.meta?.style_desc||"å€™é¸çµæœï¼ˆé»åœ–å¯æ”¹é¸ï¼‰")+(job.meta?.review_needed?" ï½œå»ºè­°äººå·¥æª¢è¦–":"");
  list.forEach((r,i)=>{
    const card=document.createElement("div"); card.className="card"+(i===auto?" pick":"");
    const img=document.createElement("img"); img.src=r.url; img.alt=`cand_${i+1}`; img.loading="lazy"; attachCtx(img);
    if(i===auto){ const rib=document.createElement("div"); rib.className="ribbon"; rib.textContent="è‡ªå‹•æŒ‘"; card.appendChild(rib); }
    else{ const t=document.createElement("div"); t.className="tag"; t.textContent="å€™é¸"; card.appendChild(t); }
    if(r.scores && typeof r.scores.total==="number"){
      const chip=document.createElement("div"); chip.className="chip"; chip.textContent=`ç¸½åˆ† ${r.scores.total}`; card.appendChild(chip);
      const row=document.createElement("div"); row.className="scores"; row.innerHTML=`<span class="mini">è‡‰ ${r.scores.identity ?? "-"}</span><span class="mini">è‰² ${r.scores.color ?? "-"}</span>`; card.appendChild(row);
    }
    card.appendChild(img);
    card.onclick=()=>{ [...document.querySelectorAll(".card")].forEach(el=>el.classList.remove("pick")); card.classList.add("pick"); state.pick=i+1; };
    grid.appendChild(card);
  });
  state.pick=auto+1;
  document.getElementById("hint").textContent=list.length?`å·²è¼‰å…¥ ${list.length} å¼µï¼Œé è¨­ä½¿ç”¨ç¬¬ ${state.pick} å¼µ`:"æ­¤ä»»å‹™ç›®å‰æ²’æœ‰å€™é¸åœ–";
  const desc = job.meta?.style_desc || null;
  const sd   = document.getElementById('styleDesc');
  if (sd) sd.textContent = desc ? `åƒè€ƒé«®å‹ç‰¹å¾µï¼š${desc}` : '';
  if(job.meta?.user_src){ state.userPath=job.meta.user_src; const im=document.getElementById("userThumb"); im.src=job.meta.user_src; im.closest(".uploader").classList.add("has-img"); }
  if(job.meta?.style_src){ state.stylePath=job.meta.style_src; const im=document.getElementById("styleThumb"); im.src=job.meta.style_src; im.closest(".uploader").classList.add("has-img"); }
}

async function loadJob(id){ busy(true,"è®€å–ä»»å‹™ä¸­â€¦"); try{ const job=await fetchJob(id); state.job=id; render(job); } finally{ busy(false); } }

// ä¸è‡ªå‹•è¼‰å…¥ä»»ä½• jobï¼ˆå¤šäººå…±ç”¨é¿å…æ´©æ¼ä¸Šä¸€ä½å®¢äººè³‡æ–™ï¼‰
(function initBlank(){
  const sd = document.getElementById('styleDesc'); if (sd) sd.textContent = '';
  const grid = document.getElementById('grid'); if (grid) grid.innerHTML = '';
  const cmp = document.getElementById('compareWrap'); if (cmp) cmp.style.display='none';
  window.state = { job:null, pick:1, meta:null, userPath:null, stylePath:null };
})();

/* ä¸Šå‚³é è¦½ï¼‹é‡é¸ */
document.querySelectorAll(".uploader .redo").forEach(btn=>{
  btn.addEventListener("click",(ev)=>{ ev.stopPropagation(); const box=btn.closest(".uploader"); const input=box.querySelector("input"); const img=box.querySelector("img");
    input.value=""; img.removeAttribute("src"); box.classList.remove("has-img"); input.click(); });
});

document.getElementById('use').onclick = async () => {
  try{
    if(!window.state?.job){
      alert('è«‹å…ˆå»ºç«‹ä¸€æ¬¡ä»»å‹™');
      return;
    }
    const pick = Number(window.state.pick || 1);

    // Busy
    const busyBox=document.getElementById('busy'), busyText=document.getElementById('busyText');
    if(busyBox&&busyText){ busyText.textContent='ç”¢ç”Ÿå°æ¯”åœ–ä¸­â€¦'; busyBox.style.display='flex'; }

    // å‘¼å« compareï¼ˆVercel æœƒ rewrite åˆ° Firebaseï¼‰
    const body = JSON.stringify({
      job_id: String(window.state.job),
      pick,
      title: (window.state?.meta?.style_desc || 'æ˜ é«®ï½œä¸€é¡æ›é«®')
    });
    const r = await fetch('/api/compare', { method:'POST', headers:{'Content-Type':'application/json'}, body });
    const data = await r.json();
    if(!r.ok){ throw new Error(data?.error || r.statusText); }

    // å–ç¯€é»
    const wrap = document.getElementById('compareWrap');
    const img  = document.getElementById('compareImg');
    const link = document.getElementById('compareLink');

    // è¨ºæ–·ï¼šæŠŠ URL å°å‡ºä¾†ç¢ºèª
    console.log('[compare] url =', data.compare_url);

    // é¡¯ç¤ºå€å¡Š
    wrap.style.display = '';

    // æ­£ç¢ºé™„åŠ  cache-busterï¼ˆé¿å…å‡ºç¾å…©å€‹ ? é€ æˆ 404ï¼‰
    const u = new URL(data.compare_url);
    u.searchParams.set('t', Date.now());

    // load / error è¨ºæ–·
    img.onload  = () => console.log('[compare] loaded', img.naturalWidth, img.naturalHeight);
    img.onerror = (e) => console.error('[compare] img error', e, img.src);

    img.loading = 'lazy';
    img.alt     = 'compare preview';
    img.src     = u.toString();              // â† é€™è¡ŒæœƒçœŸçš„æ›´æ–°å½±åƒ
    link.href   = data.compare_url;          // ã€Œåœ¨æ–°åˆ†é é–‹å•Ÿã€ç¶­æŒåŸç°½åç¶²å€
  }catch(e){
    console.error('[ui] compare error:', e);
    alert('å°æ¯”åœ–ç”¢ç”Ÿå¤±æ•—ï¼š' + (e?.message || e));
  }finally{
    const busyBox=document.getElementById('busy');
    if(busyBox) busyBox.style.display='none';
  }
};

// æ”¾åœ¨ä½ ç¾æœ‰ <script> å…§å³å¯ï¼ˆhelpers å€ï¼‰
async function fileToB64(file){
  return await new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => {
      // r.result æ˜¯ dataURLï¼Œå–é€—è™Ÿå¾Œé¢çš„ç´” base64
      const s = String(r.result||"");
      const idx = s.indexOf(",");
      resolve(idx>=0 ? s.slice(idx+1) : s);
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* â€”â€” ä¿è­‰ newRun ç¶å®šï¼ˆåƒ…ç¶ä¸€æ¬¡ï¼‰ â€”â€” */
(function wireNewRunOnce(){
  const btn = document.getElementById('newRun');
  const userInput=document.getElementById('userFile'), styleInput=document.getElementById('styleFile');
  if (!btn || btn.dataset.bound==='1') return;
  btn.dataset.bound='1';
  console.log('[ui] new-run bound');

  btn.addEventListener('click', async ()=>{
    const uf = userInput?.files?.[0], sf = styleInput?.files?.[0];
    if(!uf || !sf){ return alert('è«‹å…ˆé¸å–ã€Œé¡§å®¢ç…§ / åƒè€ƒé«®å‹ã€'); }

    // è®€æª” â†’ base64
    const [u64, s64] = await Promise.all([fileToB64(uf), fileToB64(sf)]);

    // é€åˆ°å¾Œç«¯ï¼ˆJSON ç‰ˆï¼‰
    const body = JSON.stringify({
      user_b64: u64,
      style_b64: s64,
      user_mime: uf.type || "image/jpeg",
      style_mime: sf.type || "image/jpeg"
    });

    // é¡¯ç¤ºå¿™ç¢Œï¼ˆå¦‚æœä½ æœ‰ busy å…ƒä»¶å°±æ‰“é–‹ï¼‰
    const busyBox=document.getElementById('busy'); const busyText=document.getElementById('busyText');
    if(busyBox&&busyText){ busyText.textContent='ä¸Šå‚³èˆ‡ç”Ÿæˆä¸­ï¼ˆç´„ 10â€“40 ç§’ï¼‰â€¦'; busyBox.style.display='flex'; }

    try{
      // ç”¨ç›¸å°è·¯å¾‘å‘¼å«ï¼ˆVercel rewrite æœƒè½‰åˆ° Firebaseï¼‰
      const r = await fetch('/api/new-run-b64', { method:'POST', headers:{'Content-Type':'application/json'}, body });
      const data = await r.json();
      if(!r.ok){ throw new Error(JSON.stringify(data)); }

      // å›å¡«é è¦½ï¼ˆæ³¨æ„ï¼šé€™è£¡æ˜¯çµ•å° URLï¼Œä¸èƒ½åœ¨å‰é¢åŠ  "/"ï¼‰
      if (data.user)  document.getElementById('userThumb').src  = data.user;
      if (data.style) document.getElementById('styleThumb').src = data.style;

      // è¼‰å…¥æœ€æ–° jobï¼ˆä½ å·²æœ‰ loadJob å‡½å¼ï¼‰
      if (data.job_id){
        window.state = window.state || {};
        window.state.job = data.job_id;   // â˜… æŠŠ job_id å­˜èµ·ä¾†
        if (typeof loadJob === 'function') await loadJob(String(data.job_id));
      }

      // è®“å»ºç«‹æˆåŠŸå°±å…ˆé¡¯ç¤º style_desc
      if (data.style_desc) {
        const sd = document.getElementById('styleDesc');
        if (sd) sd.textContent = `åƒè€ƒé«®å‹ç‰¹å¾µï¼š${data.style_desc}`;
      }

      // ï¼ˆå¯é¸ï¼‰è‡ªå‹•ç”¢å‡ºå°æ¯”åœ–ï¼šå‘¼å« /api/compare
      // const cmpRes = await fetch('/api/compare', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({job_id: data.job_id, pick: 1, title:"æ˜ é«®ï½œä¸€é¡æ›é«®"})});
      // const cmp = await cmpRes.json();
      // if (cmp.compare_url){ const img = document.getElementById('compareImg'); document.getElementById('compareWrap').style.display=''; img.src = cmp.compare_url; }

      alert('å»ºç«‹æˆåŠŸï¼š' + data.job_id);
    }catch(e){
      console.error('[ui] new-run error:', e);
      alert('å»ºç«‹å¤±æ•—ï¼š' + (e?.message || e));
    }finally{
      if(busyBox) busyBox.style.display='none';
    }
  });

  // æ¸…é™¤æ­¤é è³‡æ–™æŒ‰éˆ•
  document.getElementById('wipe').onclick = ()=>{
    // æ¸…å‰ç«¯ç‹€æ…‹èˆ‡ç•«é¢
    window.state = { job:null, pick:1, meta:null, userPath:null, stylePath:null };
    const ids = ['userThumb','styleThumb','styleDesc','grid','compareImg'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if (id==='grid') el.innerHTML='';
      else if (id==='compareImg') el.src='';
      else if (id==='styleDesc') el.textContent='';
      else el.removeAttribute('src');
    });
    const cmp = document.getElementById('compareWrap'); if (cmp) cmp.style.display='none';
    // æ¸… session è³‡æ–™
    sessionStorage.clear();
    // è§£é™¤æª”æ¡ˆ input å€¼
    document.getElementById('userFile').value='';
    document.getElementById('styleFile').value='';
    alert('å·²æ¸…ç©ºæ­¤é è³‡æ–™ã€‚');
  };

  // é€šç”¨ï¼šæŠŠ file input è½‰ base64 é è¦½ï¼ˆä½ å·²æœ‰é¡ä¼¼åŠŸèƒ½å¯ç•™å­˜ï¼‰
  // é€™è£¡åªåšç¸®åœ–é è¦½
  function setPreview(fileInputId, imgId){
    const file = document.getElementById(fileInputId);
    const img  = document.getElementById(imgId);
    if (!file || !img) return;
    file.addEventListener('change', ev => {
      const f = ev.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      img.src = url;
    });
  }

  // ç¶å®šä¸€çµ„ã€Œæ‹ç…§/ç›¸ç°¿ã€æŒ‰éˆ•
  function bindCameraGallery({ fileId, cameraBtnId, galleryBtnId }){
    const file   = document.getElementById(fileId);
    const camBtn = document.getElementById(cameraBtnId);
    const galBtn = document.getElementById(galleryBtnId);
    if (!file || !camBtn || !galBtn) return;

    camBtn.onclick = (e) => {
      e.preventDefault();
      // iOS/Androidï¼šæœ‰ capture æ™‚å¹¾ä¹å¼·åˆ¶é–‹ç›¸æ©Ÿï¼ˆå¾Œé¡é ­ï¼‰
      file.setAttribute('capture', 'environment');
      file.click();
    };
    galBtn.onclick = (e) => {
      e.preventDefault();
      // ç§»é™¤ capture â†’ é–‹ç›¸ç°¿/æª”æ¡ˆæŒ‘é¸
      file.removeAttribute('capture');
      file.click();
    };
  }

  // å•Ÿç”¨ï¼šé¡§å®¢ç…§ / åƒè€ƒé«®å‹
  setPreview('userFile','userThumb');
  setPreview('styleFile','styleThumb');

  bindCameraGallery({
    fileId: 'userFile', cameraBtnId: 'btnUserCamera', galleryBtnId: 'btnUserGallery'
  });
  bindCameraGallery({
    fileId: 'styleFile', cameraBtnId: 'btnStyleCamera', galleryBtnId: 'btnStyleGallery'
  });
})();
</script>
</body>
</html>





